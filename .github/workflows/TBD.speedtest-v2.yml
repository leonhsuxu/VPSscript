name: â³ TGé¢‘é“å’Œç¾¤æŠ“å–èŠ‚ç‚¹æµ‹é€Ÿ XC-speedtestæµ‹é€Ÿç‰ˆ
on:
  schedule:
    - cron: '10 */4 * * *'  # æ¯4å°æ—¶æ‰§è¡Œ
  workflow_dispatch:
env:
  MIHOMO_VERSION: v1.19.17
  SPEEDTEST_VERSION: v0.4.1 # è¯·æ ¹æ®éœ€è¦æ›´æ–°åˆ°æ‚¨å¸Œæœ›çš„ç‰ˆæœ¬ï¼Œä¾‹å¦‚ v0.4.1
  TELEGRAM_CHANNEL_IDS: |
    # è®¢é˜…è½¬å‘-é¢‘é“
    @fqDINYUE
    # æœºåœºè®¢é˜…èŠ‚ç‚¹VPNåˆ†äº«ç¤¾
    @wxdy666
    # ç™½å«–è®¢é˜…&èŠ‚ç‚¹åˆ†äº«ç¾¤
    @freeyule
    # CCå®ç›’
    @ccbaohe
    # Duang VPSäº¤æµç¾¤
    @duangvpsfs         
    # ç™½å«–æœºåœºäº¤æµç¾¤   
    @zzzjjjkkkoi
    # Méº¦å½“åŠ³ å…¨å®¶æ¡¶
    @xmdexw
    # v2clash å…è´¹åˆ†äº«ä¸­å¿ƒ
    @v2v2clash
    # è®¢é˜…åˆ†äº«ä¸­å¿ƒ
    @dingyue_Center
    # â€»ä¸ªäººçš„è®¢é˜…æ”¶é›† leon
    @tempssrlink
    # (ä¹±ä¸ƒå…«ç³Ÿåå­—)
    @sorenab2   
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # ç¡®ä¿å®Œæ•´å†å²ï¼Œæ–¹ä¾¿æ¨é€æ”¹åŠ¨
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ç¼“å­˜ Python ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip          
          pip install -r requirements.txt          
          
      - name: Cache Mihomo
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: mihomo
          key: mihomo-amd64-${{ env.MIHOMO_VERSION }}
          restore-keys: mihomo-amd64-${{ env.MIHOMO_VERSION }}
          
      - name: Download Mihomo æŒ‡å®šç‰ˆæœ¬
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        run: |
          set -e
          TAG=${{ env.MIHOMO_VERSION }}
          echo "ä¸‹è½½ Mihomo ç‰ˆæœ¬: $TAG"
          URL="https://github.com/MetaCubeX/mihomo/releases/download/${TAG}/mihomo-linux-amd64-${TAG}.gz"
          echo "ä¸‹è½½åœ°å€: $URL"
          curl --head --fail -s "$URL" || (echo "ä¸‹è½½é“¾æ¥ä¸å¯ç”¨ï¼Œé€€å‡º" && exit 1)
          wget --tries=5 --timeout=60 --progress=bar:force "$URL"
          gunzip "mihomo-linux-amd64-${TAG}.gz"
          mv "mihomo-linux-amd64-${TAG}" mihomo
          chmod +x mihomo
          ./mihomo -v
          
      - name: Cache xiecang speedtest-clash
        id: cache-xc
        uses: actions/cache@v4
        with:
          path: xcspeedtest
          key: xiecang-${{ env.SPEEDTEST_VERSION }}
          restore-keys: xiecang-${{ env.SPEEDTEST_VERSION }}
          
      - name: Download xiecang speedtest-clash
        if: steps.cache-xc.outputs.cache-hit != 'true'
        run: |
          set -e
          RELEASE_TAG=${{ env.SPEEDTEST_VERSION }}
          echo "å°è¯•ä¸‹è½½ speedtest-clash ç‰ˆæœ¬: $RELEASE_TAG"
          URL=$(curl -s "https://api.github.com/repos/xiecang/speedtest-clash/releases/tags/${RELEASE_TAG}" \
                | grep "browser_download_url.*speedtest-clash_Linux_x86_64" | cut -d '"' -f4)
          if [ -z "$URL" ]; then
            echo "è­¦å‘Š: æœªæ‰¾åˆ°æŒ‡å®šç‰ˆæœ¬ ${RELEASE_TAG} çš„ speedtest-clash_Linux_x86_64 èµ„äº§ï¼Œå°è¯•è·å–æœ€æ–°ç‰ˆæœ¬ã€‚"
            URL=$(curl -s https://api.github.com/repos/xiecang/speedtest-clash/releases/latest \
                | grep "browser_download_url.*speedtest-clash_Linux_x86_64" | cut -d '"' -f4)
          fi
          if [ -z "$URL" ]; then
            echo "é”™è¯¯: æœªèƒ½æ‰¾åˆ° speedtest-clash çš„ä¸‹è½½é“¾æ¥ï¼Œé€€å‡ºã€‚"
            exit 1
          fi
          FILENAME=$(basename "$URL")
          echo "ä¸‹è½½åœ°å€ï¼š$URL"
          echo "ä¿å­˜åˆ°æ–‡ä»¶ï¼š$FILENAME"
          wget --tries=5 --timeout=60 --progress=bar:force -O "$FILENAME" "$URL"
          if [[ "$FILENAME" == *.tar.gz ]]; then
            echo "æ£€æµ‹åˆ°å‹ç¼©åŒ…ï¼Œå¼€å§‹è§£å‹..."
            tar -xzf "$FILENAME"
            if [ -f "speedtest-clash" ]; then
              echo "æ‰¾åˆ°è§£å‹åçš„äºŒè¿›åˆ¶æ–‡ä»¶ 'speedtest-clash'ã€‚"
              mv speedtest-clash xcspeedtest
            else
              echo "æœªæ‰¾åˆ°æ ‡å‡†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–å¯æ‰§è¡Œæ–‡ä»¶..."
              EXE_PATH=$(find . -maxdepth 1 -type f -executable -name "speedtest-clash*" -print -quit)
              if [ -n "$EXE_PATH" ]; then
                echo "æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼š$EXE_PATH"
                mv "$EXE_PATH" xcspeedtest
              else
                echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° speedtest-clash å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€€å‡ºã€‚"
                exit 1
              fi
            fi
            rm "$FILENAME"
          else
            echo "ä¸‹è½½çš„æ–‡ä»¶ä¸ºç›´æ¥å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‡å‘½åä¸º xcspeedtestã€‚"
            mv "$FILENAME" xcspeedtest
          fi
          chmod +x xcspeedtest
          echo "speedtest-clash ä¸‹è½½å¹¶å‡†å¤‡å®Œæˆã€‚"
          echo "æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼š"
          ./xcspeedtest --help
          
      - name: è¿è¡Œ Telegram æŠ“å–åŠ Clash æµ‹é€Ÿè„šæœ¬
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
          TELEGRAM_CHANNEL_IDS: ${{ env.TELEGRAM_CHANNEL_IDS }}
        run: |
          mkdir -p flclashyaml
          python TelegramNode/TBD-telegram_publiclink.py
          
      # - name: è¿è¡Œ speedtest-clash è¿›è¡Œæµ‹é€Ÿ
      #   run: |
      #     ./xcspeedtest -c flclashyaml/Tg-node1.yaml -output flclashyaml/speedtest_result.yaml
      
      - name: æäº¤ç”Ÿæˆçš„ Clash é…ç½®åˆ°ä»“åº“
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add flclashyaml/Tg-node1.yaml
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ•’ æ›´æ–°Tg-node.yaml é…ç½® $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S CST')"
            git push
          else
            echo "æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          fi
