# å·¥ä½œæµçš„åç§°
name: ğŸ”„ HeatheCloud.URL-update

# å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */12 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå…è®¸æ‚¨åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨ç‚¹å‡» "Run workflow"
  workflow_dispatch:

# å®šä¹‰å·¥ä½œä»»åŠ¡
jobs:
  # ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼šå¹¶è¡Œä¸‹è½½å¹¶ç”Ÿæˆæ–‡ä»¶åˆ°æŒ‡å®šç›®å½•
  sync-and-generate:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        # !!! æ‚¨å”¯ä¸€éœ€è¦ä¿®æ”¹çš„åœ°æ–¹æ˜¯è¿™é‡Œ !!!
        # ä¸ºæ‚¨çš„æ¯ä¸ªæºåœ°å€æ·»åŠ ä¸€ä¸ªæ¡ç›®
        include:
          - url: "https://pastecode.dev/raw/ki7zml2s/%E5%81%A5%E5%BA%B7%E4%B8%AD%E5%BF%83618pro" # pro
            filename: "HeathCloud618pro"
          - url: "https://pastecode.dev/raw/hntbocnp/%E5%81%A5%E5%BA%B7%E4%B8%AD%E5%BF%83618ord" # ord
            filename: "HeathCloud618ord"
          - url: "https://example.com/some/data.txt" # ç¤ºä¾‹ï¼šæ‚¨çš„ç¬¬ä¸‰ä¸ªåœ°å€
            filename: "source_three"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create destination directory
        run: mkdir -p flclashyaml/TG.HeathCloud618
        # 'mkdir -p' ä¼šåˆ›å»ºæ‰€æœ‰å¿…éœ€çš„çˆ¶ç›®å½•ï¼Œä¸”å¦‚æœç›®å½•å·²å­˜åœ¨ä¹Ÿä¸ä¼šæŠ¥é”™

      - name: Fetch content and create TXT file
        run: |
          # å°†æ–‡ä»¶è¾“å‡ºåˆ°æŒ‡å®šç›®å½•ä¸‹
          curl -sL -o "flclashyaml/TG.HeathCloud618/${{ matrix.filename }}.txt" "${{ matrix.url }}"

      - name: Create YML file
        run: |
          # å®šä¹‰ç›®æ ‡æ–‡ä»¶è·¯å¾„å˜é‡ï¼Œä½¿è„šæœ¬æ›´æ¸…æ™°
          TXT_FILE="flclashyaml/TG.HeathCloud618/${{ matrix.filename }}.txt"
          YML_FILE="flclashyaml/TG.HeathCloud618/${{ matrix.filename }}.yml"

          # åˆ›å»º .yml æ–‡ä»¶ï¼Œå¹¶å°†åŸå§‹å†…å®¹ä½œä¸º 'content' å­—æ®µçš„å€¼
          echo "source_url: \"${{ matrix.url }}\"" > "$YML_FILE"
          echo "sync_timestamp: \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"" >> "$YML_FILE"
          echo "content: |" >> "$YML_FILE"
          sed 's/^/  /' "$TXT_FILE" >> "$YML_FILE"

      # å°†åŒ…å«ç”Ÿæˆæ–‡ä»¶çš„æ•´ä¸ªæ–‡ä»¶å¤¹æ‰“åŒ…ï¼Œä»¥ä¾¿ä¸‹ä¸€ä¸ªä»»åŠ¡ä½¿ç”¨
      - name: Upload generated files artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-files
          path: flclashyaml/

  # ç¬¬äºŒä¸ªä»»åŠ¡ï¼šåœ¨æ‰€æœ‰æ–‡ä»¶ç”Ÿæˆåï¼Œç»Ÿä¸€æäº¤
  commit-changes:
    runs-on: ubuntu-latest
    needs: sync-and-generate
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ä¸‹è½½ç”±ä¸Šä¸€ä¸ªä»»åŠ¡æ‰“åŒ…çš„æ•´ä¸ªæ–‡ä»¶å¤¹
      - name: Download all generated files artifact
        uses: actions/download-artifact@v4
        with:
          name: generated-files
          # å°†ä¸‹è½½çš„å†…å®¹æ”¾ç½®åˆ°ä»“åº“çš„æ ¹ç›®å½•ï¼Œå®ƒä¼šæ¢å¤ flclashyaml/ çš„ç›®å½•ç»“æ„
          path: .

      - name: Commit and push if changed
        run: |
          # é…ç½® Git
          git config --global user.name 'GitHub Action Bot'
          git config --global user.email 'actions@github.com'
          
          # ç›´æ¥æ·»åŠ æ•´ä¸ªç›®æ ‡æ–‡ä»¶å¤¹åˆ°æš‚å­˜åŒº
          git add flclashyaml/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ›´æ”¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸è¿›è¡Œæäº¤
          if git diff --staged --quiet; then
            echo "Content has not changed. No commit needed."
          else
            git commit -m "Auto-update: Sync content to flclashyaml/ folder"
            git push
          fi
