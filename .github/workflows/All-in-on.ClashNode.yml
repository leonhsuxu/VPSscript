name: ✈️ 固定订阅链接.节点更新
on:
  schedule:
    # 每天 (北京时间 6:30) 自动运行
    - cron: '30 22 * * *'
  workflow_dispatch: # 允许手动触发
  push:
    branches:
      - main
    # 注意：[1]这里的路径无法使用变量，如果修改了脚本路径，需要手动同步修改此处
    paths:
      - 'flclashyaml/All-in-one_ClashNode.py'
permissions:
  contents: write
jobs:
  update:
    runs-on: ubuntu-latest
    env:
      # --- 您可以在这里集中修改所有变量 ---
      CLASH_OUTPUT_FILENAME: TG-SSRProxy.yaml         # <-- 输出的配置文件名
      PYTHON_SCRIPT_PATH: flclashyaml/All-in-one_ClashNode.py  # [2]<-- 要执行的 Python 脚本路径 修改第二处
      COMMIT_MESSAGE_PREFIX: "✈️ TG群分享.节点更新"           # <-- Git 提交信息的前缀

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    - name: 设置 Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml
    - name: 运行合并与重命名脚本
      run: |
        # 脚本将通过 CLASH_OUTPUT_FILENAME 知道要输出的文件名
        # 通过 PYTHON_SCRIPT_PATH 引用要执行的脚本
        python ${{ env.PYTHON_SCRIPT_PATH }}
    - name: 提交更新到仓库
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        # 使用变量来添加文件
        git add flclashyaml/${{ env.CLASH_OUTPUT_FILENAME }}
        if ! git diff --staged --quiet; then
          # 使用变量作为提交信息的前缀
          git commit -m "${{ env.COMMIT_MESSAGE_PREFIX }} $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push
        else
          echo "文件无变化，无需提交。"
        fi
