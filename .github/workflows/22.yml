name: Clash Subscription Updater

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è‡ªåŠ¨æ›´æ–°

jobs:
  fetch-clash-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Fetch Clash subscription
      run: |
        echo "========================================"
        echo "Clash è®¢é˜…æ›´æ–°å™¨"
        echo "========================================"
        echo ""
        echo "ğŸ“¡ æ­£åœ¨ä»è®¢é˜…é“¾æ¥è·å–é…ç½®..."
        
        # æ¨¡æ‹Ÿ Clash å®¢æˆ·ç«¯çš„ User-Agent
        curl -L \
          -H "User-Agent: clash" \
          -H "Accept: */*" \
          "https://pastecode.dev/raw/hntbocnp/%E5%81%A5%E5%BA%B7%E4%B8%AD%E5%BF%83618ord" \
          -o HeathCloud618ord.yaml
        
        if [ $? -eq 0 ]; then
          echo "âœ“ é…ç½®æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          echo ""
          echo "æ–‡ä»¶ä¿¡æ¯:"
          ls -lh HeathCloud618ord.yaml
        else
          echo "âœ— ä¸‹è½½å¤±è´¥"
          exit 1
        fi
    
    - name: Install YAML tools
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
    
    - name: Validate configuration
      run: |
        echo ""
        echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼..."
        
        if yq eval '.' HeathCloud618ord.yaml > /dev/null 2>&1; then
          echo "âœ“ YAML æ ¼å¼éªŒè¯é€šè¿‡"
        else
          echo "âœ— YAML æ ¼å¼é”™è¯¯"
          exit 1
        fi
    
    - name: Parse configuration (simulate Clash client)
      run: |
        echo ""
        echo "========================================"
        echo "é…ç½®æ–‡ä»¶è§£æç»“æœ"
        echo "========================================"
        echo ""
        
        # ç«¯å£é…ç½®
        echo "ã€ç›‘å¬ç«¯å£ã€‘"
        PORT=$(yq eval '.port // "7890"' HeathCloud618ord.yaml)
        SOCKS_PORT=$(yq eval '.socks-port // "7891"' HeathCloud618ord.yaml)
        MIXED_PORT=$(yq eval '.mixed-port // "7892"' HeathCloud618ord.yaml)
        
        echo "  HTTP ä»£ç†ç«¯å£: $PORT"
        echo "  SOCKS5 ç«¯å£: $SOCKS_PORT"
        echo "  æ··åˆç«¯å£: $MIXED_PORT"
        echo ""
        
        # è¿è¡Œæ¨¡å¼
        echo "ã€è¿è¡Œæ¨¡å¼ã€‘"
        MODE=$(yq eval '.mode // "rule"' HeathCloud618ord.yaml)
        LOG_LEVEL=$(yq eval '.log-level // "info"' HeathCloud618ord.yaml)
        ALLOW_LAN=$(yq eval '.allow-lan // false' HeathCloud618ord.yaml)
        
        echo "  æ¨¡å¼: $MODE"
        echo "  æ—¥å¿—çº§åˆ«: $LOG_LEVEL"
        echo "  å…è®¸å±€åŸŸç½‘è¿æ¥: $ALLOW_LAN"
        echo ""
        
        # ä»£ç†èŠ‚ç‚¹ç»Ÿè®¡
        echo "ã€ä»£ç†èŠ‚ç‚¹ã€‘"
        PROXY_COUNT=$(yq eval '.proxies | length' HeathCloud618ord.yaml)
        echo "  èŠ‚ç‚¹æ€»æ•°: $PROXY_COUNT"
        
        if [ "$PROXY_COUNT" -gt 0 ]; then
          echo ""
          echo "  èŠ‚ç‚¹åˆ—è¡¨ï¼ˆå‰10ä¸ªï¼‰:"
          yq eval '.proxies[0:10] | .[] | "    - " + .name + " (" + .type + ")"' HeathCloud618ord.yaml
        fi
        echo ""
        
        # ä»£ç†ç»„
        echo "ã€ç­–ç•¥ç»„ã€‘"
        GROUP_COUNT=$(yq eval '.proxy-groups | length' HeathCloud618ord.yaml)
        echo "  ç­–ç•¥ç»„æ€»æ•°: $GROUP_COUNT"
        
        if [ "$GROUP_COUNT" -gt 0 ]; then
          echo ""
          echo "  ç­–ç•¥ç»„åˆ—è¡¨:"
          yq eval '.proxy-groups | .[] | "    - " + .name + " [" + .type + "]"' HeathCloud618ord.yaml
        fi
        echo ""
        
        # è§„åˆ™
        echo "ã€åˆ†æµè§„åˆ™ã€‘"
        RULE_COUNT=$(yq eval '.rules | length' HeathCloud618ord.yaml)
        echo "  è§„åˆ™æ€»æ•°: $RULE_COUNT"
        
        if [ "$RULE_COUNT" -gt 0 ]; then
          echo ""
          echo "  è§„åˆ™é¢„è§ˆï¼ˆå‰5æ¡ï¼‰:"
          yq eval '.rules[0:5] | .[]' HeathCloud618ord.yaml | sed 's/^/    /'
        fi
        echo ""
        
        echo "========================================"
        echo "âœ“ é…ç½®è§£æå®Œæˆ"
        echo "========================================"
    
    -
