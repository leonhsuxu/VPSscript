name: Fetch and Commit Pastecode Content

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch content from pastecode
        run: |
          echo "æ­£åœ¨è·å–æ•°æ®..."
          curl -L \
               -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
               -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
               -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
               -H "Accept-Encoding: gzip, deflate, br" \
               -H "Connection: keep-alive" \
               --compressed \
               "https://pastecode.dev/raw/hntbocnp/%E5%81%A5%E5%BA%B7%E4%B8%AD%E5%BF%83618ord" \
               -o data.yaml
          
          echo "================================"
          echo "è·å–åˆ°çš„å†…å®¹å‰30è¡Œ:"
          head -n 30 data.yaml
          echo "================================"
          
          if [ -f data.yaml ] && [ -s data.yaml ]; then
            echo "âœ“ æ•°æ®è·å–æˆåŠŸ"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < data.yaml) bytes"
            echo "è¡Œæ•°: $(wc -l < data.yaml) lines"
          else
            echo "âœ— æ•°æ®è·å–å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data.yaml
          git commit -m "ğŸ”„ æ›´æ–°æ•°æ® - $(date +'%Y-%m-%d %H:%M:%S')" || echo "æ— éœ€æäº¤"
          git push || echo "æ— éœ€æ¨é€"
          echo "âœ“ æ•°æ®å·²æ›´æ–°"
      
      - name: Summary
        run: |
          echo "### æ‰§è¡Œæ‘˜è¦ ğŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰§è¡Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- æ•°æ®æº: pastecode.dev" >> $GITHUB_STEP_SUMMARY
          echo "- è¾“å‡ºæ–‡ä»¶: data.yaml" >> $GITHUB_STEP_SUMMARY
          if [ -f data.yaml ]; then
            echo "- æ–‡ä»¶å¤§å°: $(wc -c < data.yaml) bytes" >> $GITHUB_STEP_SUMMARY
            echo "- æ–‡ä»¶è¡Œæ•°: $(wc -l < data.yaml) lines" >> $GITHUB_STEP_SUMMARY
          fi
