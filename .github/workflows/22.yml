name: Clash Subscription Update

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡

jobs:
  update-subscription:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Simulate Clash fetching subscription
      run: |
        echo "=========================================="
        echo "Clash è®¢é˜…æ›´æ–°æ¨¡æ‹Ÿå™¨"
        echo "=========================================="
        echo ""
        echo "ðŸ“¡ æ­£åœ¨ä»Žè®¢é˜…åœ°å€èŽ·å–é…ç½®..."
        echo "URL: https://pastecode.dev/raw/hntbocnp/å¥åº·ä¸­å¿ƒ618ord"
        echo ""
        
        # æ¨¡æ‹Ÿ Clash å‘é€è¯·æ±‚ï¼ˆå¸¦ User-Agentï¼‰
        curl -A "Clash" \
             -H "Accept: application/yaml" \
             "https://pastecode.dev/raw/hntbocnp/%E5%81%A5%E5%BA%B7%E4%B8%AD%E5%BF%83618ord" \
             > HeathCloud618ord.yaml
        
        if [ $? -eq 0 ]; then
          echo "âœ“ è®¢é˜…æ›´æ–°æˆåŠŸ"
          echo ""
          echo "ðŸ“Š é…ç½®æ–‡ä»¶ä¿¡æ¯:"
          ls -lh HeathCloud618ord.yaml
          echo ""
          FILE_SIZE=$(stat -f%z HeathCloud618ord.yaml 2>/dev/null || stat -c%s HeathCloud618ord.yaml)
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
        else
          echo "âœ— è®¢é˜…æ›´æ–°å¤±è´¥"
          exit 1
        fi
    
    - name: Install YAML parser
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
    
    - name: Parse and validate config
      run: |
        echo "=========================================="
        echo "é…ç½®æ–‡ä»¶è§£æžï¼ˆæ¨¡æ‹Ÿ Clash åŠ è½½é…ç½®ï¼‰"
        echo "=========================================="
        echo ""
        
        # éªŒè¯ YAML æ ¼å¼
        if ! yq eval '.' HeathCloud618ord.yaml > /dev/null 2>&1; then
          echo "âœ— YAML æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æž"
          exit 1
        fi
        
        echo "âœ“ YAML æ ¼å¼éªŒè¯é€šè¿‡"
        echo ""
        
        # è¯»å–åŸºç¡€é…ç½®
        echo "ã€åŸºç¡€é…ç½®ã€‘"
        echo "ç«¯å£: $(yq eval '.port // "æœªè®¾ç½®"' HeathCloud618ord.yaml)"
        echo "SOCKS ç«¯å£: $(yq eval '.socks-port // "æœªè®¾ç½®"' HeathCloud618ord.yaml)"
        echo "æ··åˆç«¯å£: $(yq eval '.mixed-port // "æœªè®¾ç½®"' HeathCloud618ord.yaml)"
        echo "æ¨¡å¼: $(yq eval '.mode // "rule"' HeathCloud618ord.yaml)"
        echo "æ—¥å¿—çº§åˆ«: $(yq eval '.log-level // "info"' HeathCloud618ord.yaml)"
        echo "å…è®¸å±€åŸŸç½‘: $(yq eval '.allow-lan // false' HeathCloud618ord.yaml)"
        echo ""
        
        # ç»Ÿè®¡èŠ‚ç‚¹
        PROXY_COUNT=$(yq eval '.proxies | length' HeathCloud618ord.yaml 2>/dev/null || echo "0")
        echo "ã€ä»£ç†èŠ‚ç‚¹ã€‘"
        echo "èŠ‚ç‚¹æ€»æ•°: $PROXY_COUNT"
        echo ""
        
        if [ "$PROXY_COUNT" -gt 0 ]; then
          echo "èŠ‚ç‚¹åˆ—è¡¨ï¼ˆå‰10ä¸ªï¼‰:"
          yq eval '.proxies[0:10] | .[] | .name' HeathCloud618ord.yaml 2>/dev/null | nl
          echo ""
        fi
        
        # ç»Ÿè®¡ä»£ç†ç»„
        GROUP_COUNT=$(yq eval '.proxy-groups | length' HeathCloud618ord.yaml 2>/dev/null || echo "0")
        echo "ã€ä»£ç†ç»„ã€‘"
        echo "ä»£ç†ç»„æ€»æ•°: $GROUP_COUNT"
        echo ""
        
        if [ "$GROUP_COUNT" -gt 0 ]; then
          echo "ä»£ç†ç»„åˆ—è¡¨:"
          yq eval '.proxy-groups | .[] | .name' HeathCloud618ord.yaml 2>/dev/null | nl
          echo ""
        fi
        
        # ç»Ÿè®¡è§„åˆ™
        RULE_COUNT=$(yq eval '.rules | length' HeathCloud618ord.yaml 2>/dev/null || echo "0")
        echo "ã€è§„åˆ™é›†ã€‘"
        echo "è§„åˆ™æ€»æ•°: $RULE_COUNT"
        echo ""
        
        echo "=========================================="
        echo "é…ç½®åŠ è½½å®Œæˆ âœ“"
        echo "=========================================="
    
    - name: Generate update log
      run: |
        echo "ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
        cat > update_log.txt << EOF
        æ›´æ–°æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
        è®¢é˜…åœ°å€: https://pastecode.dev/raw/hntbocnp/å¥åº·ä¸­å¿ƒ618ord
        é…ç½®æ–‡ä»¶: HeathCloud618ord.yaml
        çŠ¶æ€: æˆåŠŸ
        EOF
        
        cat update_log.txt
    
    - name: Commit updated config
      run: |
        git config --local user.email "clash-bot@github.com"
        git config --local user.name "Clash Bot"
        git add HeathCloud618ord.yaml update_log.txt
        
        if git diff --quiet && git diff --staged --quiet; then
          echo ""
          echo "â„¹ï¸  é…ç½®æ–‡ä»¶æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
        else
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "ðŸ”„ Update Clash subscription - $TIMESTAMP"
          git push
          echo ""
          echo "âœ“ é…ç½®æ–‡ä»¶å·²æ›´æ–°å¹¶æŽ¨é€åˆ°ä»“åº“"
        fi
