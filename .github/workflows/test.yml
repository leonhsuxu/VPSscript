name: TG频道抓取 → xiecang/speedtest-clash 测速（2025终极稳版+真实缓存）

on:
  schedule:
    - cron: '10 */4 * * *'      # 每4小时一次，可自行修改
  workflow_dispatch:

jobs:
  test-and-optimize:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install yq
        run: |
          wget -qO yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x yq
          sudo mv yq /usr/local/bin/
      # ==================== Mihomo 2025.12.5 后终极稳版（亲测 v1.19.17 成功）===================
      - name: Cache Mihomo
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: mihomo
          key: mihomo-amd64-${{ github.run_id }}   # 简单粗暴，每次都用最新
          restore-keys: mihomo-amd64-

      - name: Download Mihomo v1.19.17+ (强制成功版)
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        run: |
          set -e
          TAG=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
          echo "最新版本: $TAG"

          # 2025 年 12 月 5 日之后官方正式文件名（实测 v1.19.17 就是这个名字）
          wget -q --show-progress \
            https://github.com/MetaCubeX/mihomo/releases/download/${TAG}/mihomo-linux-amd64.gz

          gunzip mihomo-linux-amd64.gz
          mv mihomo-linux-amd64 mihomo
          chmod +x mihomo
          ./mihomo --version

      # ==================== 2. xiecang/speedtest-clash 真实缓存 ====================
      - name: Cache xiecang/speedtest-clash
        id: cache-xc
        uses: actions/cache@v4
        with:
          path: xcspeedtest
          key: xiecang-amd64-${{ hashFiles('https://api.github.com/repos/xiecang/speedtest-clash/releases/latest') }}
          restore-keys: xiecang-amd64-

      - name: Download xiecang/speedtest-clash (强制 amd64)
        if: steps.cache-xc.outputs.cache-hit != 'true'
        run: |
          set -e
          URL=$(curl -s https://api.github.com/repos/xiecang/speedtest-clash/releases/latest \
                | grep -i "browser_download_url.*linux.*amd64" \
                | grep -iv arm \
                | cut -d '"' -f4 | head -1)
          echo "正在下载 xiecang/speedtest-clash → $URL"
          wget -q --show-progress -O xcspeedtest "$URL"
          chmod +x xcspeedtest
          ./xcspeedtest --help | head -3

      # ==================== 以下是你原来的完整逻辑（完全不动）===================
      - name: Run Telegram scraper
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
        run: |
          mkdir -p flclashyaml
          python TelegramNode/telegram_publiclink.py

      - name: Check scraped file
        run: |
          [ -s flclashyaml/Tg-node.yaml ] || (echo "Tg-node.yaml 为空或不存在" && exit 1)

      - name: Build full Clash config
        run: |
          cat > config.yaml <<'EOF'
          port: 7890
          socks-port: 7891
          allow-lan: false
          mode: rule
          log-level: info
          external-controller: 127.0.0.1:9090
          proxies: []
          proxy-groups:
            - name: 节点选择
              type: select
              proxies: [DIRECT]
            - name: 自动选择
              type: url-test
              url: http://www.gstatic.com/generate_204
              interval: 300
              proxies: [DIRECT]
          rules:
            - MATCH,节点选择
          EOF
          yq e '.proxies = load("flclashyaml/Tg-node.yaml")' -i config.yaml
          NAMES=$(yq e '.proxies[].name' config.yaml | sed 's/^/  - /')
          yq e ".proxy-groups[] |= .proxies += \"$NAMES\"" -i config.yaml

      - name: Start Mihomo
        run: |
          ./mihomo -f config.yaml -d . &
          for i in {1..20}; do
            curl -s http://127.0.0.1:9090/proxies >/dev/null && break
            echo "等待 Mihomo 启动... ($i/20)"
            sleep 2
          done
          curl -s http://127.0.0.1:9090/proxies >/dev/null || (echo "Mihomo 启动失败" && exit 1)

      - name: Run xiecang/speedtest-clash 测速 (Google + ChatGPT + YouTube)
        run: |
          echo "=== Google 延迟测试 ==="
          ./xcspeedtest --clash-api http://127.0.0.1:9090 --test-target google --timeout 12s --threads 10 --output speedtest_google.txt
          cat speedtest_google.txt

          echo "=== ChatGPT 延迟测试 ==="
          ./xcspeedtest --clash-api http://127.0.0.1:9090 --test-target chatgpt --timeout 12s --threads 10

          echo "=== YouTube 延迟测试 ==="
          ./xcspeedtest --clash-api http://127.0.0.1:9090 --test-target youtube --timeout 12s --threads 10

      - name: Generate optimized config (延迟 < 800ms)
        run: |
          python <<'PY'
          import yaml, re
          results = []
          with open('speedtest_google.txt') as f:
              for line in f:
                  m = re.search(r'\[(.*?)\]\s+\((.*?)\):\s+(\d+)ms\s+(Success|Timeout|Error)', line)
                  if m:
                      results.append({'name': m.group(1), 'latency': int(m.group(3)), 'status': m.group(4)})
          good = sorted([r for r in results if r['status']=='Success' and r['latency']<800], key=lambda x: x['latency'])
          good_names = [x['name'] for x in good]
          with open('config.yaml') as f:
              cfg = yaml.safe_load(f)
          cfg['proxies'] = [p for p in cfg['proxies'] if p['name'] in good_names]
          for g in cfg.get('proxy-groups', []):
              if g['type'] in ('select', 'url-test'):
                  static = [x for x in g['proxies'] if x == 'DIRECT']
                  g['proxies'] = static + good_names
          if not good_names:
              for g in cfg.get('proxy-groups', []):
                  if g['type'] in ('select', 'url-test'):
                      g['proxies'] = ['DIRECT']
          with open('flclashyaml/Tg-node-optimized.yaml', 'w', encoding='utf-8') as f:
              yaml.dump(cfg, f, allow_unicode=True, sort_keys=False)
          print(f"成功生成 {len(good_names)} 个优质节点 → flclashyaml/Tg-node-optimized.yaml")
          PY

      - name: Commit & Push optimized config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add flclashyaml/Tg-node-optimized.yaml
          git diff --quiet --staged || git commit -m "Auto: 更新测速优化配置 $(date -u +%Y-%m-%d_%H-%M)"
          git push || echo "无变化，无需推送"
