name: Clash Speedtest 测速流程

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 支持手动触发，并传入自定义参数

jobs:
  speedtest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 代码
        uses: actions/checkout@v3

      - name: Setup Python 3
        uses: actions/setup-python@v4
        with:
          python-version: 3.8

      - name: 下载 clash-speedtest 可执行文件并授权
        run: |
          wget -qO clash-speedtest https://github.com/Dreamacro/clash/releases/latest/download/clash-speedtest-linux-amd64
          chmod +x clash-speedtest
          ./clash-speedtest -h

      - name: 运行 Clash Speedtest 脚本
        env:
          INPUT_PATH: ${{ github.event.inputs.input_path || 'flclashyaml/Tg-node.yaml' }}
          OUTPUT_PATH: ${{ github.event.inputs.output_path || 'flclashyaml/1.yaml' }}
          MAX_LATENCY: ${{ github.event.inputs.max_latency || '800ms' }}
          MIN_SPEED: ${{ github.event.inputs.min_speed || '5' }}
        run: |
          python3 clash_speedtest_local.py

      - name: 上传测速结果
        uses: actions/upload-artifact@v4
        with:
          name: clash-speedtest-result
          path: ${{ github.event.inputs.output_path || 'flclashyaml/1.yaml' }}
