name: ⏳ Tg频道群抓取节点测速(缓存版)

on:
  schedule:
    - cron: '0 0,12 * * *' 
  workflow_dispatch: 

env:
  CLASH_VERSION: v1.18.0 
  # TELEGRAM_CHANNEL_IDS 可以在这里或作为 Secret 配置
  TELEGRAM_CHANNEL_IDS: |
         # 订阅转发-频道
         @fqDINYUE
         # 机场订阅节点VPN分享社 
         @wxdy666
         # 白嫖订阅&节点分享群
         @freeyule
         # CC宝盒
         @ccbaohe
         # Duang VPS交流群
         @duangvpsfs         
         # 白嫖机场交流群   
         @zzzjjjkkkoi
         # M麦当劳 全家桶
         @xmdexw
         # v2clash 免费分享中心
         @v2v2clash
         # -1002400305087
         # 订阅分享中心
         @dingyue_Center
         # ※个人的订阅收集 leon
         @tempssrlink

jobs:
  build:
    runs-on: ubuntu-latest 

    steps:
      - name: 检出代码仓库
        uses: actions/checkout@v4 

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      # === 缓存 Python 依赖 ===
      - name: 缓存 Python 依赖
        id: cache-pip-dependencies 
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip # pip 的缓存目录
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }} # 基于操作系统和 requirements.txt 文件哈希的键
          restore-keys: |
            ${{ runner.os }}-pip- # 当主键未命中时，尝试匹配更通用的键

      - name: 安装 Python 依赖
        run: |
          python -m pip install --upgrade pip
          # 如果缓存命中，pip 会从本地缓存安装，速度非常快
          pip install -r requirements.txt 
          echo "Python 依赖安装完成。"

      # === 缓存 Clash Meta 核心 ===
      - name: 缓存 Clash Meta 核心
        id: cache-clash-core 
        uses: actions/cache@v4
        with:
          path: clash_core/
          key: ${{ runner.os }}-clash-meta-core-${{ env.CLASH_VERSION }} 

      - name: 如果 Clash 核心缓存未命中，则下载并解压
        if: steps.cache-clash-core.outputs.cache-hit != 'true'
        run: |
          echo "Clash Meta 核心缓存未命中，正在下载..."
          mkdir -p clash_core
          CLASH_URL="https://github.com/MetaCubeX/Clash.Meta/releases/download/${{ env.CLASH_VERSION }}/clash.meta-linux-amd64-${{ env.CLASH_VERSION }}.tar.gz"
          echo "正在从 ${CLASH_URL} 下载 Clash Meta 核心..."
          wget -O clash.meta.tar.gz "${CLASH_URL}"
          tar -xzf clash.meta.tar.gz -C clash_core
          mv clash_core/clash.meta clash_core/clash
          echo "Clash Meta 核心下载完成。"
      
      - name: 确保 Clash 核心可执行
        run: |
          chmod +x clash_core/clash
          echo "Clash Meta 核心已设置为可执行状态。"

      - name: 配置 Telegram (从 Secrets 读取敏感信息) 和运行脚本
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
          # TELEGRAM_CHANNEL_IDS 从 env: 块中自动获取
        run: |
          echo "正在运行 Clash 测速脚本..."
          python TelegramNode/telegram_publiclink.py
          echo "脚本执行完成。"

      - name: 上传生成的 Clash 配置
        uses: actions/upload-artifact@v4
        with:
          name: clash-config-output
          path: flclashyaml/telegram_scraper.yaml
          retention-days: 7
