name: â³ TGé¢‘é“&ç¾¤æŠ“å–èŠ‚ç‚¹æµ‹é€Ÿ (clash-speedtestæµ‹é€Ÿç‰ˆ)
on:
  schedule:
    - cron: '10 */4 * * *'  # æ¯6å°æ—¶æ‰§è¡Œ
  workflow_dispatch:
env:
  CLASH_SPEEDTEST_VERSION: v1.7.0  # è¯·æ ¹æ®éœ€è¦æ›¿æ¢ä¸ºç›®æ ‡ç‰ˆæœ¬
  TELEGRAM_CHANNEL_IDS: |
    # è®¢é˜…è½¬å‘-é¢‘é“
    @fqDINYUE
    # æœºåœºè®¢é˜…èŠ‚ç‚¹VPNåˆ†äº«ç¤¾
    @wxdy666
    # ç™½å«–è®¢é˜…&èŠ‚ç‚¹åˆ†äº«ç¾¤
    @freeyule
    # CCå®ç›’
    @ccbaohe
    # Duang VPSäº¤æµç¾¤
    @duangvpsfs         
    # ç™½å«–æœºåœºäº¤æµç¾¤   
    @zzzjjjkkkoi
    # Méº¦å½“åŠ³ å…¨å®¶æ¡¶
    @xmdexw
    # v2clash å…è´¹åˆ†äº«ä¸­å¿ƒ
    @v2v2clash
    # è®¢é˜…åˆ†äº«ä¸­å¿ƒ
    @dingyue_Center
    # â€»ä¸ªäººçš„è®¢é˜…æ”¶é›† leon
    @tempssrlink
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # ç¡®ä¿å®Œæ•´å†å²ï¼Œæ–¹ä¾¿æ¨é€æ”¹åŠ¨
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: ç¼“å­˜ Python ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: ç¼“å­˜ clash-speedtest æ ¸å¿ƒ (clash_core/)
        id: cache-clash-speedtest
        uses: actions/cache@v4
        with:
          path: clash_core/
          key: ${{ runner.os }}-clash-speedtest-${{ env.CLASH_SPEEDTEST_VERSION }}
      - name: ä¸‹è½½å¹¶è§£å‹ clash-speedtest åˆ° clash_core/clash
        if: steps.cache-clash-speedtest.outputs.cache-hit != 'true'
        run: |
          mkdir -p clash_core
          URL="https://github.com/faceair/clash-speedtest/releases/download/${{ env.CLASH_SPEEDTEST_VERSION }}/clash-speedtest_Linux_x86_64.tar.gz"
          echo "æ­£åœ¨ä¸‹è½½ clash-speedtest æ ¸å¿ƒ..."
          wget -q -O clash-speedtest.tar.gz "$URL"
          tar -xzf clash-speedtest.tar.gz -C clash_core
          rm -f clash-speedtest.tar.gz
          mv clash_core/clash-speedtest clash_core/clash
          chmod +x clash_core/clash
          echo "clash-speedtest ä¸‹è½½å¹¶è§£å‹å®Œæˆã€‚"
      - name: è¿è¡Œ Telegram æŠ“å–åŠ Clash æµ‹é€Ÿè„šæœ¬
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
          TELEGRAM_CHANNEL_IDS: ${{ env.TELEGRAM_CHANNEL_IDS }}
        run: |
          mkdir -p flclashyaml
          python TelegramNode/telegram_publiclink.py
      - name: æäº¤ç”Ÿæˆçš„ Clash é…ç½®åˆ°ä»“åº“
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add flclashyaml/Tg-node.yaml
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ•’ æ›´æ–°Tg-node.yaml é…ç½® $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S CST')"
            git push
          else
            echo "æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          fi
