name: TG频道和群抓取节点测速 XC-speedtest测速版
on:
  schedule:
    - cron: '10 */4 * * *'  # 每4小时执行一次
  workflow_dispatch:        # 支持手动触发
env:
  MIHOMO_VERSION: v1.19.17
  SPEEDTEST_VERSION: v0.4.1  # 需要时更新版本号
  WGCF_VERSION: v2.2.29      # WARP wgcf 工具版本
  TELEGRAM_CHANNEL_IDS: |
    # 频道和群列表，换行分隔
    @fqDINYUE
    @wxdy666
    @freeyule
    @ccbaohe
    @duangvpsfs         
    @zzzjjjkkkoi
    @xmdexw
    @v2v2clash
    @dingyue_Center
    @tempssrlink
    @sorenab2
    @proxyshareCN
jobs:
  build:
    runs-on: ubuntu-latest # 使用 Ubuntu Linux Runner
    steps:
      # 1. 检出代码仓库
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. 设置 Python 环境
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. 缓存 Python 依赖
      - name: 缓存 Python 依赖
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      # 4. 安装 Python 依赖及系统依赖
      - name: 安装 Python 依赖及系统依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update -qq
          sudo apt-get install -y wireguard-tools curl resolvconf
          echo "检查 WireGuard 模块状态:"
          sudo modprobe wireguard 2>&1 || true
          lsmod | grep wireguard || echo "⚠️ WireGuard 模块可能未加载"
      
      # 5. 缓存 Mihomo 程序
      - name: Cache Mihomo
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: mihomo
          key: mihomo-amd64-${{ env.MIHOMO_VERSION }}
          restore-keys: mihomo-amd64-${{ env.MIHOMO_VERSION }}
      
      # 6. 下载 Mihomo 指定版本（如果缓存未命中）
      - name: Download Mihomo 指定版本
        if: steps.cache-mihomo.outputs.cache-hit != 'true'
        run: |
          set -e
          TAG=${{ env.MIHOMO_VERSION }}
          URL="https://github.com/MetaCubeX/mihomo/releases/download/${TAG}/mihomo-linux-amd64-${TAG}.gz"
          echo "尝试访问下载链接"
          if ! curl --head --fail "$URL"; then
            echo "下载地址不可用！"
            exit 1
          fi
          wget --tries=3 --timeout=30 -O mihomo.gz "$URL"
          gunzip -f mihomo.gz
          chmod +x mihomo
          ./mihomo -v
      
      # 7. 缓存 wgcf 工具
      - name: Cache wgcf tool
        id: cache-wgcf
        uses: actions/cache@v4
        with:
          path: wgcf
          key: wgcf-linux-amd64-${{ env.WGCF_VERSION }}
          restore-keys: wgcf-linux-amd64-${{ env.WGCF_VERSION }}
      
      # 8. 下载 wgcf 工具（如果缓存未命中）
      - name: Download wgcf tool
        if: steps.cache-wgcf.outputs.cache-hit != 'true'
        run: |
          WGCF_FULL_VERSION="${{ env.WGCF_VERSION }}"
          WGCF_FILENAME_VERSION="${WGCF_FULL_VERSION#v}" 
          echo "正在下载 wgcf v${WGCF_FILENAME_VERSION}..."
          curl -fsSL -o wgcf https://github.com/ViRb3/wgcf/releases/download/${WGCF_FULL_VERSION}/wgcf_${WGCF_FILENAME_VERSION}_linux_amd64
          if [ ! -f "wgcf" ]; then
            echo "错误：wgcf 下载失败！"
            exit 1
          fi
          chmod +x wgcf
          echo "wgcf 下载完成。"
      
      # 9. 缓存 speedtest-clash 程序
      - name: Cache xiecang speedtest-clash
        id: cache-xc
        uses: actions/cache@v4
        with:
          path: xcspeedtest
          key: xiecang-${{ env.SPEEDTEST_VERSION }}
          restore-keys: xiecang-${{ env.SPEEDTEST_VERSION }}
      
      # 10. 下载 speedtest-clash 指定版本（如果缓存未命中）
      - name: Download xiecang speedtest-clash
        if: steps.cache-xc.outputs.cache-hit != 'true'
        run: |
          set -e
          RELEASE_TAG=${{ env.SPEEDTEST_VERSION }}
          echo "尝试下载 speedtest-clash 版本: $RELEASE_TAG"
          URL=$(curl -s "https://api.github.com/repos/xiecang/speedtest-clash/releases/tags/${RELEASE_TAG}" \
                | grep "browser_download_url.*speedtest-clash_Linux_x86_64" | cut -d '"' -f4)
          if [ -z "$URL" ]; then
            echo "警告: 未找到指定版本 (${RELEASE_TAG})，尝试使用最新版本。"
            URL=$(curl -s https://api.github.com/repos/xiecang/speedtest-clash/releases/latest \
                | grep "browser_download_url.*speedtest-clash_Linux_x86_64" | cut -d '"' -f4)
          fi
          if [ -z "$URL" ]; then
            echo "错误：未能找到 speedtest-clash 下载 URL，退出。"
            exit 1
          fi
          wget --tries=5 --timeout=60 -O downloaded_file "$URL"
          if file downloaded_file | grep -q "gzip compressed data"; then
            echo "检测到压缩包，开始解压"
            tar -xzf downloaded_file
            if [ -f "speedtest-clash" ]; then
              mv speedtest-clash xcspeedtest
            else
              EXE_PATH=$(find . -maxdepth 1 -type f -executable -name "speedtest-clash*" -print -quit)
              if [ -n "$EXE_PATH" ]; then
                mv "$EXE_PATH" xcspeedtest
              else
                echo "错误：未找到 speedtest-clash 可执行文件"
                exit 1
              fi
            fi
            rm downloaded_file
          else
            echo "下载的是可执行文件，直接重命名为 xcspeedtest"
            mv downloaded_file xcspeedtest
          fi
          chmod +x xcspeedtest
          ./xcspeedtest --help
      
      # 11. 启动 Cloudflare Warp (终极修复版)
      - name: Start Cloudflare Warp (终极修复版)
        run: |
          set +e  # 允许错误继续执行
          echo "=== Cloudflare Warp 设置开始 ==="
          
          # 0. 清理可能的冲突
          echo "清理可能存在的冲突..."
          sudo systemctl stop wg-quick@wgcf 2>/dev/null || true
          sudo wg-quick down wgcf 2>/dev/null || true
          sudo ip link delete wgcf 2>/dev/null || true
          sleep 2
          
          # 1. 确保 wgcf 工具存在
          if [ ! -f "./wgcf" ] || [ ! -x "./wgcf" ]; then
            echo "下载 wgcf 工具..."
            WGCF_VERSION="v2.2.29"
            WGCF_FILENAME_VERSION="${WGCF_VERSION#v}"
            curl -fsSL -o wgcf "https://github.com/ViRb3/wgcf/releases/download/${WGCF_VERSION}/wgcf_${WGCF_FILENAME_VERSION}_linux_amd64"
            chmod +x wgcf
            echo "wgcf 工具准备就绪"
          fi
          
          # 2. 检查是否已有账户文件
          if [ ! -f "wgcf-account.toml" ]; then
            echo "注册 WARP 账户..."
            ./wgcf register --accept-tos 2>&1
            echo "账户注册完成"
          else
            echo "使用现有 WARP 账户"
          fi
          
          # 3. 生成配置文件
          if [ ! -f "wgcf-profile.conf" ]; then
            echo "生成 WireGuard 配置文件..."
            ./wgcf generate 2>&1
            echo "配置文件生成完成"
          else
            echo "使用现有配置文件"
          fi
          
          # 4. 验证配置文件
          if [ ! -f "wgcf-profile.conf" ]; then
            echo "❌ 错误：未生成配置文件"
            exit 1
          fi
          
          echo "配置文件内容预览:"
          head -20 wgcf-profile.conf
          echo "..."
          
          # 5. 安装到系统目录
          echo "安装配置文件到系统..."
          sudo mkdir -p /etc/wireguard
          sudo cp -f wgcf-profile.conf /etc/wireguard/wgcf.conf
          sudo chmod 600 /etc/wireguard/wgcf.conf
          
          # 6. 检查 WireGuard 模块
          echo "检查 WireGuard 模块..."
          sudo modprobe wireguard 2>/dev/null || true
          if lsmod | grep -q wireguard; then
            echo "✅ WireGuard 模块已加载"
          else
            echo "⚠️ WireGuard 模块未加载，尝试安装..."
            sudo apt-get update -qq
            sudo apt-get install -y linux-modules-extra-$(uname -r) wireguard-tools 2>/dev/null || true
          fi
          
          # 7. 启动 WireGuard（多种方法尝试）
          echo "启动 WireGuard 连接..."
          
          # 方法1：使用 wg-quick
          echo "尝试方法1: wg-quick up wgcf"
          if timeout 15 sudo wg-quick up wgcf 2>&1; then
            echo "✅ 方法1成功"
          else
            echo "方法1失败，尝试方法2..."
            
            # 方法2：手动配置
            echo "尝试方法2: 手动配置"
            sudo ip link add dev wgcf type wireguard 2>/dev/null || true
            sudo wg setconf wgcf /etc/wireguard/wgcf.conf 2>&1
            sudo ip -4 address add 172.16.0.2/32 dev wgcf 2>/dev/null || true
            sudo ip -6 address add 2606:4700:110:8e6c:9b1e:ecb1:da84:a80c/128 dev wgcf 2>/dev/null || true
            sudo ip link set mtu 1280 up dev wgcf 2>/dev/null || true
            
            # 检查是否成功
            if sudo wg show wgcf 2>/dev/null | grep -q "interface: wgcf"; then
              echo "✅ 方法2成功"
            else
              echo "⚠️ 两种方法都失败，但继续执行..."
            fi
          fi
          
          # 8. 验证连接状态
          echo "=== 连接状态验证 ==="
          
          # 检查接口
          echo "WireGuard 接口状态:"
          ip link show wgcf 2>/dev/null || echo "未找到 wgcf 接口"
          
          # 检查 wg 状态
          echo "WireGuard 配置状态:"
          sudo wg show wgcf 2>/dev/null || echo "wgcf 未运行"
          
          # 测试连接
          echo "网络连接测试:"
          
          # 测试1：直接连接
          if curl -4 --max-time 5 -s https://ip.sb 2>/dev/null; then
            echo "✅ IPv4 连接正常"
          else
            echo "⚠️ IPv4 连接失败，尝试通过 Warp..."
            
            # 测试2：通过 Warp 接口
            if ip route show table all 2>/dev/null | grep -q wgcf; then
              echo "检测到 Warp 路由"
              curl -4 --interface wgcf --max-time 5 -s https://ip.sb 2>/dev/null && echo "✅ Warp IPv4 连接成功" || echo "⚠️ Warp 连接也失败"
            fi
          fi
          
          # 9. 设置路由（如果Warp没有默认路由）
          echo "设置网络路由..."
          
          # 获取当前网关
          DEFAULT_GW=$(ip route show default | awk '/default/ {print $3}')
          if [ -n "$DEFAULT_GW" ]; then
            echo "默认网关: $DEFAULT_GW"
            
            # 确保 WARP 流量走 WARP 接口
            sudo ip route add 0.0.0.0/1 dev wgcf 2>/dev/null || true
            sudo ip route add 128.0.0.0/1 dev wgcf 2>/dev/null || true
          fi
          
          # 10. 最终检查
          echo "=== 最终检查 ==="
          echo "当前所有网络接口:"
          ip -4 addr show | grep inet
          
          echo "路由表:"
          ip route show | head -10
          
          echo "DNS 设置:"
          cat /etc/resolv.conf 2>/dev/null | head -5
          
          echo "=== Warp 设置完成 ==="
          echo "注意：即使 Warp 不完全成功，脚本也会继续执行后续步骤"
          echo "等待 3 秒让网络稳定..."
          sleep 3
      
      # 12. 运行 Telegram 抓取及 Clash 测速脚本
      - name: 运行 Telegram 抓取及 Clash 测速脚本
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
          TELEGRAM_CHANNEL_IDS: ${{ env.TELEGRAM_CHANNEL_IDS }}
        run: |
          mkdir -p flclashyaml
          python TelegramNode/TBD-telegram_publiclink.py
      
      # 13. (可选) 运行 speedtest-clash 进行二次测速
      # - name: 运行 speedtest-clash 进行二次测速（可选）
      #   run: |
      #     ./xcspeedtest -c flclashyaml/Tg-node1.yaml -output flclashyaml/speedtest_result.yaml
      
      # 14. 提交生成的 Clash 配置到仓库
      - name: 提交生成的 Clash 配置到仓库
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add flclashyaml/Tg-node1.yaml
          if git diff --staged --quiet; then
            echo "文件无变化，跳过提交"
          else
            echo "检测到文件变更，正在提交..."
            COMMIT_TIME=$(python3 -c "from datetime import datetime, timedelta; print((datetime.utcnow() + timedelta(hours=8)).strftime('%Y-%m-%d %H:%M:%S CST'))")
            git commit -m "更新节点配置 ${COMMIT_TIME}"
            git push
            echo "提交成功！"
          fi
      
      # 15. 清理 Warp 连接（无论成功与否都执行）
      - name: 清理 Warp 连接
        if: always()
        run: |
          echo "=== 清理阶段 ==="
          echo "关闭 Warp 连接..."
          sudo wg-quick down wgcf 2>/dev/null || true
          echo "清理完成"
