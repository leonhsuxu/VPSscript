name: TGé¢‘é“å’Œç¾¤æŠ“å–èŠ‚ç‚¹æµ‹é€Ÿ XC-speedtestæµ‹é€Ÿç‰ˆ
# ==================== è§¦å‘æ¡ä»¶é…ç½® ====================
on:
  # å®šæ—¶æ‰§è¡Œé…ç½®
  schedule:
    # æ¯4å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œæ•´ç‚¹åçš„10åˆ†é’Ÿæ‰§è¡Œï¼ˆä¾‹å¦‚ï¼š00:10, 04:10, 08:10...ï¼‰
    - cron: '10 */4 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      # ç½‘ç»œé…ç½®æ¨¡å¼é€‰æ‹©
      warp_config:
        description: 'é€‰æ‹©ç½‘ç»œé…ç½®æ¨¡å¼'
        required: false
        default: 'default'
        type: choice
        options:
          - default        # é»˜è®¤é…ç½®ï¼šæŠ“å–ç”¨GitHubï¼Œæµ‹é€Ÿç”¨Warp
          - all_warp       # å…¨æµç¨‹ä½¿ç”¨Warpç½‘ç»œ
          - all_github     # å…¨æµç¨‹ä½¿ç”¨GitHubç½‘ç»œ
          - test_mode      # æµ‹è¯•æ¨¡å¼ï¼ˆåªæŠ“å–å°‘é‡èŠ‚ç‚¹ï¼‰
      
      # æ˜¯å¦å¼ºåˆ¶é‡æ–°ä¸‹è½½å·¥å…·
      force_download:
        description: 'å¼ºåˆ¶é‡æ–°ä¸‹è½½å·¥å…·ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean
      
      # æµ‹é€Ÿæ¨¡å¼é€‰æ‹©
      speedtest_mode:
        description: 'é€‰æ‹©æµ‹é€Ÿæ¨¡å¼'
        required: false
        default: 'tcp_first'
        type: choice
        options:
          - tcp_first     # å…ˆTCPç²—ç­›ï¼Œå†Speedtestç²¾æµ‹ï¼ˆæ¨èï¼‰
          - tcp_only      # åªç”¨TCPæµ‹é€Ÿï¼ˆæœ€å¿«ï¼‰
          - clash_only    # åªç”¨Speedtestæµ‹é€Ÿï¼ˆæœ€å‡†ï¼‰
          - clash_first   # å…ˆSpeedtestï¼Œå†TCPéªŒè¯
# ==================== ç¯å¢ƒå˜é‡é…ç½® ====================
env:
  # ==================== ç‰ˆæœ¬é…ç½® ====================
  MIHOMO_VERSION: v1.19.17           # Mihomo (Clash Meta) ç‰ˆæœ¬
  SPEEDTEST_VERSION: v0.4.1          # XC Speedtest ç‰ˆæœ¬
  WGCF_VERSION: v2.2.29              # WGCF (Cloudflare Warp) ç‰ˆæœ¬
  
  # ==================== ç½‘ç»œæ§åˆ¶é…ç½® ====================
  # è¿™äº›å˜é‡æ˜¯Pythonè„šæœ¬çš„å”¯ä¸€æ§åˆ¶æºï¼Œæ§åˆ¶å„é˜¶æ®µæ˜¯å¦ä½¿ç”¨Warpç½‘ç»œ
  # true=ä½¿ç”¨Warpç½‘ç»œï¼Œfalse=ä½¿ç”¨åŸå§‹GitHubç½‘ç»œ
  
  # æŠ“å–é˜¶æ®µï¼šä½¿ç”¨GitHubç½‘ç»œï¼ˆé€Ÿåº¦å¿«ï¼‰
  WARP_FOR_SCRAPING: "false"
  
  # TCPæµ‹é€Ÿé˜¶æ®µï¼šä½¿ç”¨Warpç½‘ç»œï¼ˆæ¨¡æ‹Ÿå›½å†…ç¯å¢ƒï¼Œæµ‹é€Ÿç»“æœæ›´å‡†ç¡®ï¼‰
  WARP_FOR_TCP: "true"
  
  # Speedtestæµ‹é€Ÿé˜¶æ®µï¼šä½¿ç”¨Warpç½‘ç»œï¼ˆæ¨¡æ‹Ÿå›½å†…ç¯å¢ƒï¼Œæµ‹é€Ÿç»“æœæ›´å‡†ç¡®ï¼‰
  WARP_FOR_SPEEDTEST: "true"
  
  # æœ€ç»ˆå¤„ç†é˜¶æ®µï¼šä½¿ç”¨GitHubç½‘ç»œï¼ˆç¡®ä¿æäº¤ç­‰æ“ä½œæ­£å¸¸ï¼‰
  WARP_FOR_FINAL: "false"
  
  # ==================== æµ‹é€Ÿç­–ç•¥é…ç½® ====================
  # æµ‹é€Ÿæ¨¡å¼é€‰é¡¹ï¼š
  #   "tcp_only"      â†’ åªç”¨ TCP æµ‹é€Ÿï¼ˆæœ€å¿«ï¼Œæœ€ä¸¥æ ¼ï¼Œé€‚åˆèŠ‚ç‚¹ç‰¹åˆ«å¤šçš„æƒ…å†µï¼‰
  #   "clash_only"    â†’ åªç”¨ Speedtest-clash æµ‹é€Ÿï¼ˆæœ€å‡†ï¼‰
  #   "tcp_first"     â†’ å…ˆ TCP ç²—ç­›ï¼ˆ<800msï¼‰â†’ å† Speedtest ç²¾æµ‹ï¼ˆæ¨èï¼å¹³è¡¡é€Ÿåº¦ä¸è´¨é‡ï¼‰
  #   "clash_first"   â†’ å…ˆ Speedtest â†’ å† TCPï¼ˆä¸€èˆ¬ç”¨ä¸ä¸Šï¼‰
  SPEEDTEST_MODE: "tcp_first"
  
  # ==================== å¸¦å®½ç­›é€‰é…ç½® ====================
  # æ˜¯å¦å¯ç”¨å¸¦å®½ç­›é€‰ï¼ˆTrue=å¯ç”¨ï¼ŒFalse=å…³é—­ï¼‰
  ENABLE_BANDWIDTH_FILTER: "true"
  
  # æœ€ä½å¸¦å®½é˜ˆå€¼ï¼ˆå•ä½ï¼šMB/sï¼‰
  # åªä¿ç•™å¸¦å®½å¤§äºç­‰äºæ­¤å€¼çš„èŠ‚ç‚¹
  MIN_BANDWIDTH_MB: "25"
  
  # ==================== æ—¥å¿—é…ç½® ====================
  # æ˜¯å¦å¯ç”¨TCPæµ‹é€Ÿè¯¦ç»†æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰
  ENABLE_TCP_LOG: "false"
  
  # æ˜¯å¦å¯ç”¨Speedtestæµ‹é€Ÿè¯¦ç»†æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰
  ENABLE_SPEEDTEST_LOG: "false"
  
  # ==================== Telegramé¢‘é“é…ç½® ====================
  # è¦æŠ“å–çš„Telegramé¢‘é“åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
  # æ”¯æŒé¢‘é“IDï¼ˆå¦‚ @channel_nameï¼‰æˆ–é¢‘é“é“¾æ¥
  TELEGRAM_CHANNEL_IDS: |
    @fqDINYUE
    @wxdy666
    @freeyule
    @ccbaohe
    @duangvpsfs         
    @zzzjjjkkkoi
    @xmdexw
    @v2v2clash
    @dingyue_Center
    @tempssrlink
    @sorenab2
    @proxyshareCN
# ==================== å·¥ä½œæµä»»åŠ¡å®šä¹‰ ====================
jobs:
  # ä¸»æ„å»ºä»»åŠ¡
  build:
    # ä½¿ç”¨æœ€æ–°çš„Ubuntuè¿è¡Œå™¨
    runs-on: ubuntu-latest
    
    # è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼‰
    timeout-minutes: 30
    
    # ä»»åŠ¡æ­¥éª¤å®šä¹‰
    steps:
      # ==================== æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“ ====================
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„å†å²è®°å½•ï¼Œä¾¿äºåç»­çš„æäº¤æ“ä½œ
          fetch-depth: 0
          # ä½¿ç”¨GitHub Tokenè¿›è¡Œè®¤è¯
          token: ${{ secrets.GITHUB_TOKEN }}
          # æ˜¯å¦æ£€å‡ºå­æ¨¡å—
          submodules: false
      
      # ==================== æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ ====================
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          # æŒ‡å®šPythonç‰ˆæœ¬ï¼ˆ3.11ï¼‰
          python-version: '3.11'
          # å¯ç”¨ç¼“å­˜ä»¥åŠ é€Ÿä¾èµ–å®‰è£…
          cache: 'pip'
          # ç¼“å­˜ä¾èµ–æ–‡ä»¶è·¯å¾„
          cache-dependency-path: '**/requirements.txt'
      
      # ==================== æ­¥éª¤3ï¼šç¼“å­˜Pythonä¾èµ– ====================
      - name: ç¼“å­˜ Python ä¾èµ–
        uses: actions/cache@v4
        id: cache-pip
        with:
          # ç¼“å­˜pipå®‰è£…åŒ…çš„ä½ç½®
          path: ~/.cache/pip
          # ç¼“å­˜çš„å”¯ä¸€æ ‡è¯†é”®ï¼ŒåŸºäºrequirements.txtçš„å“ˆå¸Œå€¼
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          # å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…çš„ç¼“å­˜ï¼Œå°è¯•æ¢å¤æœ€æ¥è¿‘çš„ç¼“å­˜
          restore-keys: |
            ${{ runner.os }}-pip-
      
      # ==================== æ­¥éª¤4ï¼šå®‰è£…Pythonä¾èµ–åŠç³»ç»Ÿä¾èµ– ====================
      - name: å®‰è£… Python ä¾èµ–åŠç³»ç»Ÿä¾èµ–
        run: |
          # å‡çº§pipåˆ°æœ€æ–°ç‰ˆæœ¬
          python -m pip install --upgrade pip
          
          # å®‰è£…requirements.txtä¸­æŒ‡å®šçš„PythonåŒ…
          pip install -r requirements.txt
          
          # æ›´æ–°ç³»ç»ŸåŒ…åˆ—è¡¨ï¼ˆé™é»˜æ¨¡å¼ï¼‰
          sudo apt-get update -qq
          
          # å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·
          sudo apt-get install -y \
            wireguard-tools \
            curl \
            resolvconf \
            wget
      
      # ==================== æ­¥éª¤5ï¼šç¼“å­˜Mihomoç¨‹åº ====================
      - name: ç¼“å­˜ Mihomo ç¨‹åº
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          # ç¼“å­˜MihomoäºŒè¿›åˆ¶æ–‡ä»¶
          path: mihomo
          # ç¼“å­˜é”®ï¼šåŸºäºæ¶æ„å’Œç‰ˆæœ¬
          key: mihomo-amd64-${{ env.MIHOMO_VERSION }}
          # æ¢å¤é”®ï¼šç›¸åŒæ¶æ„çš„ä¸åŒç‰ˆæœ¬
          restore-keys: mihomo-amd64-${{ env.MIHOMO_VERSION }}
      
      # ==================== æ­¥éª¤6ï¼šä¸‹è½½MihomoæŒ‡å®šç‰ˆæœ¬ ====================
      - name: ä¸‹è½½ Mihomo æŒ‡å®šç‰ˆæœ¬
        if: steps.cache-mihomo.outputs.cache-hit != 'true' || inputs.force_download == true
        run: |
          set -e
          TAG=${{ env.MIHOMO_VERSION }}
          URL="https://github.com/MetaCubeX/mihomo/releases/download/${TAG}/mihomo-linux-amd64-${TAG}.gz"
          
          echo "å°è¯•è®¿é—®ä¸‹è½½é“¾æ¥: $URL"
          if ! curl --head --fail "$URL"; then
            echo "âŒ é”™è¯¯ï¼šä¸‹è½½åœ°å€ä¸å¯ç”¨ï¼"
            exit 1
          fi
          
          wget --tries=3 --timeout=30 -O mihomo.gz "$URL"
          gunzip -f mihomo.gz
          chmod +x mihomo
          ./mihomo -v
      
      # ==================== æ­¥éª¤7ï¼šç¼“å­˜wgcfå·¥å…· ====================
      - name: ç¼“å­˜ wgcf å·¥å…·
        id: cache-wgcf
        uses: actions/cache@v4
        with:
          # ç¼“å­˜wgcfäºŒè¿›åˆ¶æ–‡ä»¶
          path: wgcf
          # ç¼“å­˜é”®ï¼šåŸºäºæ¶æ„å’Œç‰ˆæœ¬
          key: wgcf-linux-amd64-${{ env.WGCF_VERSION }}
          # æ¢å¤é”®
          restore-keys: wgcf-linux-amd64-${{ env.WGCF_VERSION }}
      
      # ==================== æ­¥éª¤8ï¼šä¸‹è½½wgcfå·¥å…· ====================
      - name: ä¸‹è½½ wgcf å·¥å…·
        if: steps.cache-wgcf.outputs.cache-hit != 'true' || inputs.force_download == true
        run: |
          WGCF_FULL_VERSION="${{ env.WGCF_VERSION }}"
          WGCF_FILENAME_VERSION="${WGCF_FULL_VERSION#v}" 
          echo "æ­£åœ¨ä¸‹è½½ wgcf v${WGCF_FILENAME_VERSION}..."
          
          curl -fsSL -o wgcf "https://github.com/ViRb3/wgcf/releases/download/${WGCF_FULL_VERSION}/wgcf_${WGCF_FILENAME_VERSION}_linux_amd64"
          
          if [ ! -f "wgcf" ]; then
            echo "âŒ é”™è¯¯ï¼šwgcf ä¸‹è½½å¤±è´¥ï¼"
            exit 1
          fi
          
          chmod +x wgcf
          echo "wgcf ä¸‹è½½å®Œæˆã€‚"
      
      # ==================== æ­¥éª¤9ï¼šç¼“å­˜speedtest-clashç¨‹åº ====================
      - name: ç¼“å­˜ xiecang speedtest-clash
        id: cache-xc
        uses: actions/cache@v4
        with:
          # ç¼“å­˜speedtest-clashäºŒè¿›åˆ¶æ–‡ä»¶
          path: xcspeedtest
          # ç¼“å­˜é”®ï¼šåŸºäºç‰ˆæœ¬
          key: xiecang-${{ env.SPEEDTEST_VERSION }}
          # æ¢å¤é”®
          restore-keys: xiecang-${{ env.SPEEDTEST_VERSION }}
      
      # ==================== æ­¥éª¤10ï¼šä¸‹è½½speedtest-clashæŒ‡å®šç‰ˆæœ¬ ====================
      - name: ä¸‹è½½ xiecang speedtest-clash
        if: steps.cache-xc.outputs.cache-hit != 'true' || inputs.force_download == true
        run: |
          set -e
          RELEASE_TAG=${{ env.SPEEDTEST_VERSION }}
          echo "å°è¯•ä¸‹è½½ speedtest-clash ç‰ˆæœ¬: $RELEASE_TAG"
          
          URL=$(curl -s "https://api.github.com/repos/xiecang/speedtest-clash/releases/tags/${RELEASE_TAG}" \
                | grep "browser_download_url.*speedtest-clash_Linux_x86_64" | cut -d '"' -f4)
          
          if [ -z "$URL" ]; then
            echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°æŒ‡å®šç‰ˆæœ¬ (${RELEASE_TAG})ï¼Œå°è¯•ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚"
            URL=$(curl -s https://api.github.com/repos/xiecang/speedtest-clash/releases/latest \
                | grep "browser_download_url.*speedtest-clash_Linux_x86_64" | cut -d '"' -f4)
          fi
          
          if [ -z "$URL" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªèƒ½æ‰¾åˆ° speedtest-clash ä¸‹è½½ URLï¼Œé€€å‡ºã€‚"
            exit 1
          fi
          
          wget --tries=5 --timeout=60 -O downloaded_file "$URL"
          
          if file downloaded_file | grep -q "gzip compressed data"; then
            echo "æ£€æµ‹åˆ°å‹ç¼©åŒ…ï¼Œå¼€å§‹è§£å‹"
            tar -xzf downloaded_file
            if [ -f "speedtest-clash" ]; then
              mv speedtest-clash xcspeedtest
            else
              EXE_PATH=$(find . -maxdepth 1 -type f -executable -name "speedtest-clash*" -print -quit)
              if [ -n "$EXE_PATH" ]; then
                mv "$EXE_PATH" xcspeedtest
              else
                echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° speedtest-clash å¯æ‰§è¡Œæ–‡ä»¶"
                exit 1
              fi
            fi
            rm downloaded_file
          else
            echo "ä¸‹è½½çš„æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç›´æ¥é‡å‘½åä¸º xcspeedtest"
            mv downloaded_file xcspeedtest
          fi
          
          chmod +x xcspeedtest
          ./xcspeedtest --help
      
      # ==================== æ­¥éª¤11ï¼šæ™ºèƒ½ç½‘ç»œé…ç½® ====================
      - name: æ™ºèƒ½ç½‘ç»œé…ç½®
        run: |
          echo "=== ğŸŒ æ™ºèƒ½ç½‘ç»œé…ç½® ==="
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œç½‘ç»œé…ç½®æ¨¡å¼: ${{ inputs.warp_config }}"
            
            case "${{ inputs.warp_config }}" in
              "default")
                echo "ä½¿ç”¨é»˜è®¤ç½‘ç»œé…ç½®"
                ;;
              "all_warp")
                echo "å…¨æµç¨‹ä½¿ç”¨Warpç½‘ç»œ"
                echo "WARP_FOR_SCRAPING=true" >> $GITHUB_ENV
                echo "WARP_FOR_TCP=true" >> $GITHUB_ENV
                echo "WARP_FOR_SPEEDTEST=true" >> $GITHUB_ENV
                echo "WARP_FOR_FINAL=true" >> $GITHUB_ENV
                ;;
              "all_github")
                echo "å…¨æµç¨‹ä½¿ç”¨GitHubç½‘ç»œ"
                echo "WARP_FOR_SCRAPING=false" >> $GITHUB_ENV
                echo "WARP_FOR_TCP=false" >> $GITHUB_ENV
                echo "WARP_FOR_SPEEDTEST=false" >> $GITHUB_ENV
                echo "WARP_FOR_FINAL=false" >> $GITHUB_ENV
                ;;
              "test_mode")
                echo "æµ‹è¯•æ¨¡å¼ï¼šå‡å°‘æŠ“å–æ•°é‡ï¼Œä½¿ç”¨Warpæµ‹é€Ÿ"
                echo -e "TELEGRAM_CHANNEL_IDS=@fqDINYUE\n@wxdy666\n@freeyule" >> $GITHUB_ENV
                echo "WARP_FOR_SCRAPING=false" >> $GITHUB_ENV
                echo "WARP_FOR_TCP=true" >> $GITHUB_ENV
                echo "WARP_FOR_SPEEDTEST=true" >> $GITHUB_ENV
                echo "WARP_FOR_FINAL=false" >> $GITHUB_ENV
                ;;
            esac
            
            if [ -n "${{ inputs.speedtest_mode }}" ]; then
              echo "SPEEDTEST_MODE=${{ inputs.speedtest_mode }}" >> $GITHUB_ENV
              echo "æµ‹é€Ÿæ¨¡å¼è¦†ç›–ä¸º: ${{ inputs.speedtest_mode }}"
            fi
          else
            echo "å®šæ—¶è§¦å‘ï¼Œä½¿ç”¨é»˜è®¤ç½‘ç»œé…ç½®"
          fi
          
          echo ""
          echo "ğŸ“‹ æœ€ç»ˆæ‰§è¡Œé…ç½®:"
          echo "--------------------------------------------------"
          echo "ç½‘ç»œé…ç½®:"
          echo "  - æŠ“å–é˜¶æ®µ Warp: ${{ env.WARP_FOR_SCRAPING }}"
          echo "  - TCPæµ‹é€Ÿ Warp: ${{ env.WARP_FOR_TCP }}"
          echo "  - Speedtestæµ‹é€Ÿ Warp: ${{ env.WARP_FOR_SPEEDTEST }}"
          echo "  - æœ€ç»ˆé˜¶æ®µ Warp: ${{ env.WARP_FOR_FINAL }}"
          echo ""
          echo "æµ‹é€Ÿé…ç½®:"
          echo "  - æµ‹é€Ÿæ¨¡å¼: ${{ env.SPEEDTEST_MODE }}"
          echo "  - å¸¦å®½ç­›é€‰: ${{ env.ENABLE_BANDWIDTH_FILTER }} (â‰¥${{ env.MIN_BANDWIDTH_MB }}MB/s)"
          echo "  - TCPæ—¥å¿—: ${{ env.ENABLE_TCP_LOG }}"
          echo "  - Speedtestæ—¥å¿—: ${{ env.ENABLE_SPEEDTEST_LOG }}"
          echo "--------------------------------------------------"
          echo "=== âœ… ç½‘ç»œé…ç½®å®Œæˆ ==="
      
      # ==================== æ­¥éª¤12ï¼šè¿è¡ŒTelegramæŠ“å–åŠæµ‹é€Ÿè„šæœ¬ ====================
      - name: è¿è¡Œ Telegram æŠ“å–åŠ Clash æµ‹é€Ÿè„šæœ¬
        env:
          # Telegram API å‡­è¯
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
          
          # ç½‘ç»œæ§åˆ¶å˜é‡
          WARP_FOR_SCRAPING: ${{ env.WARP_FOR_SCRAPING }}
          WARP_FOR_TCP: ${{ env.WARP_FOR_TCP }}
          WARP_FOR_SPEEDTEST: ${{ env.WARP_FOR_SPEEDTEST }}
          WARP_FOR_FINAL: ${{ env.WARP_FOR_FINAL }}
          
          # æµ‹é€Ÿé…ç½®
          SPEEDTEST_MODE: ${{ env.SPEEDTEST_MODE }}
          ENABLE_TCP_LOG: ${{ env.ENABLE_TCP_LOG }}
          ENABLE_SPEEDTEST_LOG: ${{ env.ENABLE_SPEEDTEST_LOG }}
          
          # å¸¦å®½ç­›é€‰é…ç½®
          ENABLE_BANDWIDTH_FILTER: ${{ env.ENABLE_BANDWIDTH_FILTER }}
          MIN_BANDWIDTH_MB: ${{ env.MIN_BANDWIDTH_MB }}
          
          # å…¶ä»–ç¯å¢ƒå˜é‡
          TELEGRAM_CHANNEL_IDS: ${{ env.TELEGRAM_CHANNEL_IDS }}
          GITHUB_ACTIONS: "true"
          PYTHONUNBUFFERED: "1"
          
        run: |
          mkdir -p flclashyaml
          
          echo "=== ğŸš€ å¼€å§‹æ‰§è¡ŒèŠ‚ç‚¹æŠ“å–å’Œæµ‹é€Ÿ ==="
          echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          
          echo "ğŸ“Š æ‰§è¡Œå‚æ•°æ±‡æ€»:"
          echo "--------------------------------------------------"
          echo "ç½‘ç»œé…ç½®:"
          echo "  ğŸ“¡ æŠ“å–é˜¶æ®µ: $( [ "$WARP_FOR_SCRAPING" = "true" ] && echo "ä½¿ç”¨Warp" || echo "ä½¿ç”¨GitHub" )"
          echo "  ğŸš€ TCPæµ‹é€Ÿ: $( [ "$WARP_FOR_TCP" = "true" ] && echo "ä½¿ç”¨Warp" || echo "ä½¿ç”¨GitHub" )"
          echo "  âš¡ Speedtest: $( [ "$WARP_FOR_SPEEDTEST" = "true" ] && echo "ä½¿ç”¨Warp" || echo "ä½¿ç”¨GitHub" )"
          echo "  ğŸ“ æœ€ç»ˆå¤„ç†: $( [ "$WARP_FOR_FINAL" = "true" ] && echo "ä½¿ç”¨Warp" || echo "ä½¿ç”¨GitHub" )"
          echo ""
          echo "æµ‹é€Ÿé…ç½®:"
          echo "  ğŸ¯ æµ‹é€Ÿæ¨¡å¼: $SPEEDTEST_MODE"
          echo "  ğŸ“¶ å¸¦å®½ç­›é€‰: $( [ "$ENABLE_BANDWIDTH_FILTER" = "true" ] && echo "å¯ç”¨ (â‰¥${MIN_BANDWIDTH_MB}MB/s)" || echo "å…³é—­" )"
          echo "  ğŸ“‹ æ—¥å¿—çº§åˆ«: TCP=$ENABLE_TCP_LOG, Speedtest=$ENABLE_SPEEDTEST_LOG"
          echo "--------------------------------------------------"
          echo ""
          
          echo "â–¶ï¸ å¼€å§‹æ‰§è¡ŒPythonè„šæœ¬..."
          echo "--------------------------------------------------"
          
          python TelegramNode/TBD-telegram_publiclink.py
          
          EXIT_CODE=$?
          echo ""
          echo "--------------------------------------------------"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… èŠ‚ç‚¹æŠ“å–å’Œæµ‹é€Ÿå®Œæˆ"
            
            if [ -f "flclashyaml/Tg-node1.yaml" ]; then
              FILE_SIZE=$(stat -c%s "flclashyaml/Tg-node1.yaml" 2>/dev/null || stat -f%z "flclashyaml/Tg-node1.yaml" 2>/dev/null || echo "unknown")
              echo "ğŸ“ é…ç½®æ–‡ä»¶ç”ŸæˆæˆåŠŸ: flclashyaml/Tg-node1.yaml (${FILE_SIZE} bytes)"
              
              echo "ğŸ“„ é…ç½®æ–‡ä»¶é¢„è§ˆ:"
              head -20 flclashyaml/Tg-node1.yaml
            else
              echo "âš ï¸  é…ç½®æ–‡ä»¶æœªç”Ÿæˆ"
            fi
          else
            echo "âŒ Pythonè„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
            exit $EXIT_CODE
          fi
          
          echo ""
          echo "ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "=== âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ ==="
      
      # ==================== æ­¥éª¤13ï¼šæäº¤å‰æ¸…ç†Warpè¿æ¥ ====================
      - name: æäº¤å‰æ¸…ç† Warp è¿æ¥
        if: always()
        run: |
          echo "=== ğŸ§¹ æäº¤å‰æ¸…ç† WARP è¿æ¥ ==="
          echo "æ¸…ç†æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          
          echo "1ï¸âƒ£ æ£€æŸ¥å½“å‰ç½‘ç»œçŠ¶æ€:"
          CURRENT_IP=$(curl -4 -s --max-time 5 https://ip.sb 2>/dev/null || echo "æ— æ³•è·å–")
          echo "   å½“å‰å‡ºå£ IP: $CURRENT_IP"
          
          echo "2ï¸âƒ£ åœæ­¢ WARP VPN..."
          sudo wg-quick down wgcf 2>/dev/null || echo "   WARPæœªè¿è¡Œæˆ–åœæ­¢å¤±è´¥"
          
          echo "3ï¸âƒ£ æ¸…ç†ç½‘ç»œæ¥å£..."
          sudo ip link delete wgcf 2>/dev/null || echo "   æ¥å£ä¸å­˜åœ¨æˆ–åˆ é™¤å¤±è´¥"
          
          echo "4ï¸âƒ£ æ¸…ç†æ™ºèƒ½è·¯ç”±é…ç½®..."
          github_ranges=(
            "140.82.112.0/20"
            "185.199.108.0/22"
            "185.199.109.0/22"
            "185.199.110.0/22"
            "185.199.111.0/22"
          )
          
          cleaned_count=0
          for cidr in "${github_ranges[@]}"; do
            sudo ip route del $cidr 2>/dev/null && cleaned_count=$((cleaned_count + 1)) || true
          done
          echo "   å·²æ¸…ç† $cleaned_count ä¸ªGitHubè·¯ç”±"
          
          echo "5ï¸âƒ£ åˆ·æ–°DNSç¼“å­˜..."
          sudo systemctl restart systemd-resolved 2>/dev/null || echo "   DNSåˆ·æ–°å¤±è´¥"
          
          echo "6ï¸âƒ£ æµ‹è¯•GitHubè¿æ¥..."
          echo "   DNSè§£ææµ‹è¯•:"
          timeout 5 nslookup github.com 2>&1 | head -3 || echo "   DNSè§£æå¤±è´¥"
          
          echo "   HTTPè¿æ¥æµ‹è¯•:"
          timeout 5 curl -I --silent https://github.com 2>&1 | head -2 || echo "   HTTPè¿æ¥å¤±è´¥"
          
          echo "7ï¸âƒ£ ç­‰å¾…ç½‘ç»œç¨³å®š..."
          sleep 3
          
          echo "8ï¸âƒ£ éªŒè¯æ¸…ç†ç»“æœ:"
          FINAL_IP=$(curl -4 -s --max-time 5 https://ip.sb 2>/dev/null || echo "æ— æ³•è·å–")
          echo "   æœ€ç»ˆå‡ºå£ IP: $FINAL_IP"
          
          if echo "$FINAL_IP" | grep -q "162.159\|172.64"; then
            echo "   âš ï¸  æ£€æµ‹åˆ°å¯èƒ½ä»æ˜¯Warp IPï¼Œä½†å·²å°½åŠ›æ¸…ç†"
          else
            echo "   âœ… æ¸…ç†å®Œæˆï¼Œå·²æ¢å¤åŸå§‹ç½‘ç»œ"
          fi
          
          echo ""
          echo "=== âœ… ç½‘ç»œæ¸…ç†å®Œæˆ ==="
      
      # ==================== æ­¥éª¤14ï¼šæäº¤ç”Ÿæˆçš„Clashé…ç½®åˆ°ä»“åº“ ====================
      - name: æäº¤ç”Ÿæˆçš„ Clash é…ç½®åˆ°ä»“åº“
        if: success()
        run: |
          echo "=== æäº¤å˜æ›´åˆ°GitHub ==="
          echo "æäº¤æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"

          if ! git diff --quiet --cached flclashyaml/Tg-node1.yaml; then
            echo "æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜æ›´"

            git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add flclashyaml/Tg-node1.yaml

            # ä½¿ç”¨ heredoc å®Œå…¨é¿å…å¼•å·å’Œåæ–œæ é—®é¢˜
            COMMIT_TIME=$(python3 -c "$(cat <<'EOF'
from datetime import datetime, timedelta
print((datetime.utcnow() + timedelta(hours=8)).strftime("%Y-%m-%d %H:%M:%S CST"))
EOF
            )")

            NODE_INFO=$(python3 -c "$(cat <<'EOF'
import yaml, sys
try:
    with open("flclashyaml/Tg-node1.yaml", "r", encoding="utf-8") as f:
        data = yaml.safe_load(f)
        proxies = data.get("proxies", [])
        node_count = len(proxies) if isinstance(proxies, list) else 0
        avg_quality = data.get("average_quality", "N/A")
        quality_stats = data.get("quality_stats", {})
        warp_tcp = data.get("speedtest_config", {}).get("warp_for_tcp", "N/A")
        warp_speedtest = data.get("speedtest_config", {}).get("warp_for_speedtest", "N/A")
        quality_str = ""
        if isinstance(quality_stats, dict):
            parts = [f"{k}{v}" for k, v in quality_stats.items()]
            quality_str = "[" + " ".join(parts) + "]" if parts else ""
        print(f"{node_count} nodes | {avg_quality}åˆ† {quality_str} | TCP_Warp={warp_tcp} Speedtest_Warp={warp_speedtest}")
except Exception as e:
    print(f"è¯»å–å¤±è´¥: {str(e)[:50]}")
    print("unknown nodes")
EOF
            )")

            COMMIT_MESSAGE="è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹é…ç½® ${COMMIT_TIME} (${NODE_INFO})"

            echo "æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"
            git commit -m "$COMMIT_MESSAGE"

            # å¸¦é‡è¯•çš„æ¨é€
            for i in {1..3}; do
              echo "ç¬¬ $i æ¬¡æ¨é€..."
              if git push; then
                echo "æäº¤æˆåŠŸï¼"
                exit 0
              fi
              sleep 5
              git pull --rebase origin $(git rev-parse --abbrev-ref HEAD) || true
            done
            echo "æ¨é€å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
          else
            echo "æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
      
      # ==================== æ­¥éª¤15ï¼šæœ€ç»ˆæ¸…ç†å’ŒæŠ¥å‘Š ====================
      - name: æœ€ç»ˆæ¸…ç†å’ŒæŠ¥å‘Š
        if: always()
        run: |
          echo "=== ğŸ§¹ æœ€ç»ˆæ¸…ç† ==="
          echo "æ¸…ç†æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo ""
          
          echo "1ï¸âƒ£ ç¡®ä¿Warpå®Œå…¨åœæ­¢..."
          sudo wg-quick down wgcf 2>/dev/null || true
          sudo ip link delete wgcf 2>/dev/null || true
          
          echo "2ï¸âƒ£ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f wgcf wgcf-profile.conf mihomo.gz downloaded_file 2>/dev/null || true
          
          echo "3ï¸âƒ£ å·¥ä½œæµæ‰§è¡Œæ€»ç»“:"
          echo "   ğŸ“… æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "   ğŸ–¥ï¸  è¿è¡Œå™¨: $RUNNER_OS"
          
          if [ -f "flclashyaml/Tg-node1.yaml" ]; then
            FILE_SIZE=$(stat -c%s "flclashyaml/Tg-node1.yaml" 2>/dev/null || stat -f%z "flclashyaml/Tg-node1.yaml" 2>/dev/null || echo "unknown")
            echo "   ğŸ“ é…ç½®æ–‡ä»¶: flclashyaml/Tg-node1.yaml (${FILE_SIZE} bytes)"
            
            if command -v python3 &> /dev/null; then
              NODE_COUNT=$(python3 -c 'try: import yaml; f=open("flclashyaml/Tg-node1.yaml","r",encoding="utf-8"); data=yaml.safe_load(f); f.close(); proxies=data.get("proxies",[]); print(len(proxies) if isinstance(proxies,list) else "æ ¼å¼é”™è¯¯"); except: print("è¯»å–å¤±è´¥")')
              echo "   ğŸ”— èŠ‚ç‚¹æ•°é‡: ${NODE_COUNT}"
            fi
          else
            echo "   âŒ é…ç½®æ–‡ä»¶æœªç”Ÿæˆ"
          fi
          
          echo "5ï¸âƒ£ æœ€ç»ˆç½‘ç»œçŠ¶æ€:"
          echo "   IPåœ°å€:"
          curl -4 -s --max-time 3 https://ip.sb 2>/dev/null || echo "   è·å–å¤±è´¥"
          
          echo ""
          echo "=== âœ… æ¸…ç†å®Œæˆ ==="
