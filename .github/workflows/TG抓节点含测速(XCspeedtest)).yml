name: TG频道和群抓取节点测速 XC-speedtest测速版

on:
  schedule:
    - cron: '10 */4 * * *'
  workflow_dispatch:
    inputs:
      warp_config:
        description: '选择网络配置模式'
        required: false
        default: 'default'
        type: choice
        options:
          - default
          - all_warp
          - all_github
          - test_mode
      force_download:
        description: '强制重新下载工具（忽略缓存）'
        required: false
        default: false
        type: boolean
      speedtest_mode:
        description: '选择测速模式'
        required: false
        default: 'tcp_first'
        type: choice
        options:
          - tcp_first
          - tcp_only
          - clash_only
          - clash_first

env:
  MIHOMO_VERSION: v1.19.17
  SPEEDTEST_VERSION: v0.4.1
  WGCF_VERSION: v2.2.29

  WARP_FOR_SCRAPING: "false"
  WARP_FOR_TCP: "true"
  WARP_FOR_SPEEDTEST: "true"
  WARP_FOR_FINAL: "false"

  SPEEDTEST_MODE: "tcp_first"
  ENABLE_BANDWIDTH_FILTER: "true"
  MIN_BANDWIDTH_MB: "25"
  ENABLE_TCP_LOG: "false"
  ENABLE_SPEEDTEST_LOG: "false"

  TELEGRAM_CHANNEL_IDS: |
    @fqDINYUE
    @wxdy666
    @freeyule
    @ccbaohe
    @duangvpsfs         
    @zzzjjjkkkoi
    @xmdexw
    @v2v2clash
    @dingyue_Center
    @tempssrlink
    @sorenab2
    @proxyshareCN

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60   # 建议改为60分钟，测速偶尔会卡

    steps:
      - name: 检出代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 缓存 Python 依赖
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          sudo apt-get update -qq
          sudo apt-get install -y wireguard-tools curl resolvconf wget

      - name: 缓存 Mihomo
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: mihomo
          key: mihomo-amd64-${{ env.MIHOMO_VERSION }}

      - name: 下载 Mihomo
        if: steps.cache-mihomo.outputs.cache-hit != 'true' || inputs.force_download == true
        run: |
          TAG=${{ env.MIHOMO_VERSION }}
          URL="https://github.com/MetaCubeX/mihomo/releases/download/${TAG}/mihomo-linux-amd64-${TAG}.gz"
          wget --tries=3 --timeout=30 -O mihomo.gz "$URL"
          gunzip -f mihomo.gz
          chmod +x mihomo
          ./mihomo -v

      - name: 缓存 wgcf
        id: cache-wgcf
        uses: actions/cache@v4
        with:
          path: wgcf
          key: wgcf-linux-amd64-${{ env.WGCF_VERSION }}

      - name: 下载 wgcf
        if: steps.cache-wgcf.outputs.cache-hit != 'true' || inputs.force_download == true
        run: |
          V=${{ env.WGCF_VERSION }}
          VER=${V#v}
          curl -fsSL -o wgcf "https://github.com/ViRb3/wgcf/releases/download/${V}/wgcf_${VER}_linux_amd64"
          chmod +x wgcf

      - name: 缓存 speedtest-clash
        id: cache-xc
        uses: actions/cache@v4
        with:
          path: xcspeedtest
          key: xiecang-${{ env.SPEEDTEST_VERSION }}

      - name: 下载 speedtest-clash
        if: steps.cache-xc.outputs.cache-hit != 'true' || inputs.force_download == true
        run: |
          TAG=${{ env.SPEEDTEST_VERSION }}
          URL=$(curl -s "https://api.github.com/repos/xiecang/speedtest-clash/releases/tags/${TAG}" | grep -o "https.*speedtest-clash_Linux_x86_64" || curl -s https://api.github.com/repos/xiecang/speedtest-clash/releases/latest | grep -o "https.*speedtest-clash_Linux_x86_64")
          wget -t 5 -T 60 -O dl "$URL"
          if file dl | grep -q gzip; then
            tar -xzf dl
            mv speedtest-clash* xcspeedtest 2>/dev/null || mv speedtest-clash xcspeedtest
          else
            mv dl xcspeedtest
          fi
          chmod +x xcspeedtest
          ./xcspeedtest --help

      - name: 智能网络配置
        run: |
          echo "=== 智能网络配置 ==="
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            case "${{ inputs.warp_config }}" in
              all_warp)
                echo "WARP_FOR_SCRAPING=true" >> $GITHUB_ENV
                echo "WARP_FOR_TCP=true" >> $GITHUB_ENV
                echo "WARP_FOR_SPEEDTEST=true" >> $GITHUB_ENV
                echo "WARP_FOR_FINAL=true" >> $GITHUB_ENV
                ;;
              all_github)
                echo "WARP_FOR_SCRAPING=false" >> $GITHUB_ENV
                echo "WARP_FOR_TCP=false" >> $GITHUB_ENV
                echo "WARP_FOR_SPEEDTEST=false" >> $GITHUB_ENV
                echo "WARP_FOR_FINAL=false" >> $GITHUB_ENV
                ;;
              test_mode)
                cat >> $GITHUB_ENV <<'EOF'
          TELEGRAM_CHANNEL_IDS=@fqDINYUE
          @wxdy666
          @freeyule
          EOF
                ;;
            esac
            [[ -n "${{ inputs.speedtest_mode }}" ]] && echo "SPEEDTEST_MODE=${{ inputs.speedtest_mode }}" >> $GITHUB_ENV
          fi

          cat <<-EOF

          最终配置：
            抓取阶段 Warp : ${{ env.WARP_FOR_SCRAPING }}
            TCP测速 Warp   : ${{ env.WARP_FOR_TCP }}
            Speedtest Warp : ${{ env.WARP_FOR_SPEEDTEST }}
            最终阶段 Warp  : ${{ env.WARP_FOR_FINAL }}
            测速模式       : ${{ env.SPEEDTEST_MODE }}
          EOF

      - name: 运行抓取与测速主脚本
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_STRING_SESSION: ${{ secrets.TELEGRAM_STRING_SESSION }}
          WARP_FOR_SCRAPING: ${{ env.WARP_FOR_SCRAPING }}
          WARP_FOR_TCP: ${{ env.WARP_FOR_TCP }}
          WARP_FOR_SPEEDTEST: ${{ env.WARP_FOR_SPEEDTEST }}
          WARP_FOR_FINAL: ${{ env.WARP_FOR_FINAL }}
          SPEEDTEST_MODE: ${{ env.SPEEDTEST_MODE }}
          ENABLE_BANDWIDTH_FILTER: ${{ env.ENABLE_BANDWIDTH_FILTER }}
          MIN_BANDWIDTH_MB: ${{ env.MIN_BANDWIDTH_MB }}
          ENABLE_TCP_LOG: ${{ env.ENABLE_TCP_LOG }}
          ENABLE_SPEEDTEST_LOG: ${{ env.ENABLE_SPEEDTEST_LOG }}
          TELEGRAM_CHANNEL_IDS: ${{ env.TELEGRAM_CHANNEL_IDS }}
          PYTHONUNBUFFERED: "1"
        run: |
          mkdir -p flclashyaml
          python TelegramNode/TBD-telegram_publiclink.py

      # ==================== 终极版 Warp 清理（关键！） ====================
      - name: 终极清理 Warp（防止 push 被 CF 限流）
        if: always()
        run: |
          echo "=== 终极清理 WARP（防止 push 失败）==="
          sudo pkill -f wgcf || true
          sudo pkill -f mihomo || true

          sudo wg-quick down wgcf 2>/dev/null || true
          sudo ip link delete wgcf 2>/dev/null || true
          sudo ip link delete wgcf-profile 2>/dev/null || true

          # 清除残留路由
          sudo ip route flush table main 2>/dev/null || true
          for cidr in \
            140.82.112.0/20 185.199.108.0/22 185.199.109.0/22 \
            185.199.110.0/22 185.199.111.0/22 173.252.88.0/21 \
            192.30.252.0/22; do
            sudo ip route del $cidr 2>/dev/null || true
          done

          sudo systemctl restart networking 2>/dev/null || true
          sleep 8

          echo "清理后出口IP: $(curl -4 --max-time 10 ip.sb || echo '未知')"

      - name: 提交结果（超级稳推送）
        if: success()
        run: |
          if ! git diff --quiet flclashyaml/Tg-node1.yaml; then
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git add flclashyaml/Tg-node1.yaml

            NODE_INFO=$(python3 - <<'PY'
          import yaml, sys
          try:
            d = yaml.safe_load(open("flclashyaml/Tg-node1.yaml"))
            cnt = len(d.get("proxies",[]))
            avg = d.get("average_quality","?")
            print(f"{cnt}节点 | {avg}分")
          except:
            print("未知")
          PY
            )

            TIME=$(date -u -d '+8 hours' '+%Y-%m-%d %H:%M:%S CST')
            git commit -m "自动更新 ${TIME} (${NODE_INFO})"

            BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')

            for i in {1..5}; do
              git pull --rebase origin $BRANCH && \
              git push origin HEAD:$BRANCH && \
              echo "推送成功" && exit 0
              echo "第 $i 次失败，10秒后重试..."
              sleep 10
            done
            echo "推送彻底失败" && exit 1
          else
            echo "文件无变化，跳过提交"
          fi

      - name: 最终清理临时文件
        if: always()
        run: |
          rm -f wgcf wgcf-profile.conf mihomo xcspeedtest downloaded_file dl mihomo.gz 2>/dev/null || true
          echo "工作流结束 $(date '+%Y-%m-%d %H:%M:%S')"
